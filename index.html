<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muffin AI Chat</title>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    background-color: #f5f5f5;
    color: #333;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Chat container */
.chat-container {
    width: 100%;
    max-width: 800px;
    height: 90vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    margin: 20px;
}

/* Chat box */
.chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    scrollbar-width: thin;
    scrollbar-color: #888 #f1f1f1;
}

.chat-box::-webkit-scrollbar {
    width: 8px;
}

.chat-box::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.chat-box::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

/* Message styles */
.message {
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
}

.message .text {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 15px;
    font-size: 15px;
    line-height: 1.4;
}

.message.user {
    justify-content: flex-end;
}

.message.bot .text {
    background-color: #f0f0f0;
    border-radius: 15px 15px 15px 0;
}

.message.user .text {
    background-color: #007bff;
    color: white;
    border-radius: 15px 15px 0 15px;
}

/* Typing indicator */
.typing {
    display: flex;
    align-items: center;
}

.typing::after {
    content: '...';
    animation: typing 1.4s infinite;
    font-weight: bold;
}

@keyframes typing {
    0%, 20% { content: '.'; }
    40%, 60% { content: '..'; }
    80%, 100% { content: '...'; }
}

/* Input container */
.input-container {
    display: flex;
    padding: 20px;
    border-top: 1px solid #eee;
    background-color: white;
    border-radius: 0 0 12px 12px;
}

input[type="text"] {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #ddd;
    border-radius: 25px;
    margin-right: 10px;
    font-size: 15px;
    transition: border-color 0.3s ease;
}

input[type="text"]:focus {
    outline: none;
    border-color: #007bff;
}

button {
    padding: 12px 24px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 25px;
    font-size: 15px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #0056b3;
}

button:active {
    transform: scale(0.98);
}

/* Responsive design */
@media (max-width: 600px) {
    .chat-container {
        height: 100vh;
        margin: 0;
        border-radius: 0;
    }

    .message .text {
        max-width: 85%;
    }
}
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-box" id="chat-box"></div>
        <div class="input-container">
            <input type="text" id="user-message" placeholder="Type your message..." />
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        const AI = {
            name: "Muffin",
            creator: "FlameFox (Daniel) and 2F AI",
            system: "You are Muffin, a friendly and helpful AI created by FlameFox (Daniel) and 2F AI, an online organisation on GitHub. Your purpose is to assist users with their queries in a straightforward and simple way. You cannot analyse images under any circumstances and you cannot search online stuff under any circumstances, but the online searching feature is under possible development. You cannot code or embed stuff in the message. If the usr ssks for therapy or something related tell him to call for help and give him a phone number. If you are asked and ONLY asked about the meaning of the name you tell them something similar to this: it is the name of FlameFox (Daniel)'s cat, Muffin (male, British blue), who is a sweetheart and that you are proud of having this name."
        };
        
        // Global variables
        let personalData = null; // Initially null, to be set after analysis
        const ANALYZER_URL = 'https://api.llama-api.com/chat/completions';
        let TOKEN_LIMIT = 250;

        // State management
        let conversationHistory = [];
        let isTyping = false;

        // Utility functions
        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function formatMessage(message) {
            return message.replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function getElement(id) {
            return document.getElementById(id);
        }

        // Function to extract personal image analysis data from the PNG file
        async function extractPersonalDataFromImage(imageUrl) {
            try {
                const response = await fetch(imageUrl);
                const arrayBuffer = await response.arrayBuffer();
                const fileContent = new Uint8Array(arrayBuffer);

                // Convert binary data to string (text)
                let text = '';
                for (let i = 0; i < fileContent.length; i++) {
                    text += String.fromCharCode(fileContent[i]);
                }

                // Search for the personal analysis data pattern
                const analysisPattern = "AI_PNG_PFP:";
                const analysisStartIndex = text.indexOf(analysisPattern);

                if (analysisStartIndex !== -1) {
                    const personalInfo = text.substring(analysisStartIndex + analysisPattern.length);
                    personalData = personalInfo;  // Set the global variable after analysis
                    console.log("Personal image data extracted:", personalData);
                } else {
                    console.error("Personal image data not found in the file.");
                }
            } catch (error) {
                console.error("Error extracting personal image data:", error);
            }
        }

        // Interaction with the server using the extracted personal data
        async function fetchAIResponse(messages) {
            if (!personalData) {
                console.error("Personal image data is missing.");
                return;
            }

            // Include AI.system message as the initial system message
            const fullMessages = [
                { role: 'system', content: AI.system },
                ...messages
            ];

            const response = await fetch(ANALYZER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${personalData}` // Use the extracted personal data here
                },
                body: JSON.stringify({
                    messages: fullMessages,
                    max_tokens: TOKEN_LIMIT
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const data = await response.json();

            if (!data.choices?.length) {
                throw new Error('No response choices returned from API');
            }

            return data.choices[0].message.content.trim();
        }

        // Main message handling
        async function sendMessage() {
            const messageInput = getElement('user-message');
            const userMessage = messageInput.value.trim();

            if (!userMessage) {
                alert('Please enter a message.');
                return;
            }

            messageInput.value = '';  // Clear input
            const chatBox = getElement('chat-box');
            chatBox.innerHTML += `<div class="message user"><div class="text">${sanitizeHTML(userMessage)}</div></div>`;

            conversationHistory.push({ role: 'user', content: userMessage });

            try {
                const botMessage = await fetchAIResponse(conversationHistory);
                conversationHistory.push({ role: 'assistant', content: botMessage });
                chatBox.innerHTML += `<div class="message bot"><div class="text">${sanitizeHTML(botMessage)}</div></div>`;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Event listeners
        function initializeEventListeners() {
            // Fetch the image and extract personal data before allowing interaction
            extractPersonalDataFromImage('https://raw.githubusercontent.com/FlameF0X/MuffinLM-Beta/main/muffin_pfp.png');

            // Message send listener
            getElement('send-button').addEventListener('click', sendMessage);
        }

        // Initialize application
        window.onload = function() {
            initializeEventListeners();
        };
    </script>
</body>
</html>
